# Полная документация: Система электрохимического анализа C_iterация

> **Версия документа:** 2.2 (Legacy Mirroring)  
> **Дата:** 25 ноября 2025  
> **Платформа:** Advantech ADAM-6717 (Linux ARM)  
> **Версии ПО:** Server v12 / Worker v21

---

## Оглавление

1. [Обзор системы](#1-обзор-системы)
2. [Архитектура](#2-архитектура)
3. [Файловая структура](#3-файловая-структура)
4. [Исходный код — iter_modbus_server.c](#4-исходный-код--iter_modbus_serverc)
5. [Исходный код — adam6224_iter_step.c](#5-исходный-код--adam6224_iter_stepc)
6. [Карта регистров Modbus](#6-карта-регистров-modbus)
7. [Алгоритмы расчётов](#7-алгоритмы-расчётов)
8. [Файл конфигурации iter_params.txt](#8-файл-конфигурации-iter_paramstxt)
9. [Сборка и развёртывание](#9-сборка-и-развёртывание)
10. [История версий и исправлений](#10-история-версий-и-исправлений)
11. [Известные особенности](#11-известные-особенности)
12. [Поддержка Legacy SCADA](#12-поддержка-legacy-scada-mirroring)

---

## 1. Обзор системы

### Назначение
Программный комплекс для автоматизации **вольтамперометрии** — электрохимического метода анализа растворов. Система управляет напряжением поляризации электрода, измеряет токи на 8 аналоговых каналах, рассчитывает pH и Redox (ОВП).

### Ключевые возможности

| Функция | Описание |
|---------|----------|
| Многофазная итерация | До 5 фаз с разными параметрами напряжения |
| 8 аналоговых каналов | Одновременное измерение AI0-AI7 |
| Расчёт pH | На основе суммы токов двух фаз с EMA-фильтрацией |
| Расчёт Redox | Два независимых канала с EMA-фильтрацией |
| Modbus TCP | Порт 1502 для SCADA/HMI |
| Modbus RTU | RS-485 для панели оператора |
| Legacy Mirroring | Поддержка старой карты регистров (0x4000+) |
| Автономность | Автозапуск при подаче питания |
| Защита SD-карты | Отложенная запись (3 сек) |

### Аппаратная платформа
- **Контроллер:** Advantech ADAM-6717 (ARM Linux)
- **Аналоговый выход:** ADAM-6224 (Modbus TCP, -5V...+5V)
- **Аналоговые входы:** Встроенные в ADAM-6717 (8 каналов)
- **Связь:** Ethernet + RS-485

---

## 2. Архитектура

### Диаграмма системы

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         ADAM-6717 Controller                            │
│                                                                         │
│   ┌─────────────────────────┐         ┌─────────────────────────┐      │
│   │   iter_modbus_server    │◄───────►│    adam6224_iter_step   │      │
│   │   (iter_modbus_server   │ Modbus  │      (adam_step)        │      │
│   │         _arm)           │  TCP    │                         │      │
│   │                         │ :1502   │                         │      │
│   │  Функции:               │         │  Функции:               │      │
│   │  • Хранит параметры     │         │  • Итерация напряжения  │      │
│   │  • Modbus TCP сервер    │         │  • Чтение AI каналов    │      │
│   │  • Modbus RTU slave     │         │  • Управление AO        │      │
│   │  • Сохранение в файл    │         │  • Расчёт pH/Redox      │      │
│   │  • Синхронизация        │         │  • Запись CSV логов     │      │
│   │  • Legacy Mirroring     │         │                         │      │
│   └────────────┬────────────┘         └────────────┬────────────┘      │
│                │                                   │                    │
│     Modbus RTU │ (RS-485)                         │ Modbus TCP         │
│    /dev/ttyAP0 │                                   │ :502               │
└────────────────┼───────────────────────────────────┼────────────────────┘
                 │                                   │
                 ▼                                   ▼
          ┌─────────────┐                   ┌───────────────┐
          │  HMI Panel  │                   │  ADAM-6224    │
          │ (Weintek,   │                   │ Аналог. выход │
          │  Siemens)   │                   │  AO0: ±5V     │
          └─────────────┘                   └───────────────┘
```

---

## 3. Файловая структура и назначение файлов

### 3.1. Исполняемые файлы
*   **`iter_modbus_server_arm`**: **Сервер (Мозг)**. Хранит параметры, обеспечивает связь Modbus TCP/RTU.
*   **`adam_step`**: **Воркер (Руки)**. Выполняет измерения, управляет "железом", считает химию.

### 3.2. Скрипты управления
*   **`start_system.sh`**: **Стартер системы**.
    *   Настраивает пути к библиотекам (`LD_LIBRARY_PATH`).
    *   Убивает старые процессы во избежание конфликтов.
    *   Запускает `watchdog.sh`.
    *   Добавляется в автозагрузку (`/etc/rc.local`).
*   **`watchdog.sh`**: **Сторожевой таймер**.
    *   Работает в фоне бесконечно.
    *   Раз в 60 секунд проверяет наличие процессов `iter_modbus_server_arm` и `adam_step`.
    *   Если процесс упал — перезапускает его.

### 3.3. Файлы данных и логов
*   **`iter_params.txt`**: **Конфигурация**. Текстовый файл со всеми настройками. Читается сервером при старте и при команде RESTART.
*   **`iter_current.csv`**: **Лог текущего цикла**. Детальные данные (мВ, мА) каждого шага измерения в реальном времени.
*   **`iter_prev_full.csv`**: **Архив**. Последний успешно завершенный цикл измерений.
*   **`worker_out.log`**: **Вывод программы (stdout)**. Сообщения от `adam_step` (подключение, текущие значения).
*   **`worker_err.log`**: **Ошибки (stderr)**. Если программа упала, причина часто здесь.
*   **`watchdog.log`**: **Журнал сторожа**. История запусков и перезапусков процессов.
*   **`boot_diag.log`**: **Диагностика старта**. Отчет скрипта `start_system.sh` о начальной загрузке.

---

## 4. Исходный код — iter_modbus_server.c

### Версия: v12 (EMA + Legacy Mirroring)

### Назначение
Сервер данных и шлюз Modbus TCP/RTU. Хранит все параметры системы в памяти, обеспечивает доступ через Modbus, сохраняет изменения в файл.

### Ключевые изменения
- Параметры размера фильтра заменены на коэффициенты сглаживания Alpha.
- Добавлена поддержка "зеркальных" регистров (Mirroring) для совместимости с legacy SCADA (адреса 0x4000+).

### Адресация регистров

```c
#define INT_HEADER_REGS 6
#define INT_PHASE_REGS_PER_PHASE 12
#define FLOAT_BASE 66                    // = 6 + 5*12
#define CONTROL_REG_ADDR 132             // = 66 + 66
#define CALC_SETTINGS_START 200
#define CHEM_SETTINGS_START 400
#define RESULTS_START 1000
#define PHASE_RESULTS_START 3000
#define CHEM_RESULTS_START 4000
#define TOTAL_REGS 20000                 // Расширено для Legacy (0x4000+)
```

---

## 5. Исходный код — adam6224_iter_step.c

### Версия: v21 (EMA Update)

### Назначение
Ядро измерений. Выполняет циклы итерации напряжения, читает аналоговые входы, вычисляет pH и Redox, записывает результаты.

### Ключевые изменения
- Внедрено экспоненциальное сглаживание (EMA).
- Удалены кольцевые буферы.
- Добавлен сброс состояния фильтров при старте цикла.
- Скорректирована формула pH (деление концентрации на 10/100).

---

## 6. Карта регистров Modbus

### Полная карта (Internal)

#### Блок 400-423: Настройки химии (FLOAT32)

| Адрес | Параметр | Описание |
|-------|----------|----------|
| 400-401 | calc_k_sum | Коэффициент для суммы токов |
| 402-403 | calc_b_sum | Смещение для суммы токов |
| **404-405** | **calc_alpha_c** | **EMA Alpha для pH (0.0 - 1.0)** |
| 406-407 | calc_deadband_acid | Порог кислоты |
| 408-409 | calc_deadband_alkali | Порог щёлочи |
| 410-411 | calc_ph_neutral | pH нейтрали (обычно 7.0) |
| 412-413 | calc_k_acid | K для pH кислоты |
| 414-415 | calc_b_acid | B для pH кислоты |
| 416-417 | calc_k_alkali | K для pH щёлочи |
| 418-419 | calc_b_alkali | B для pH щёлочи |
| **420-421** | **calc_alpha_redox1** | **EMA Alpha для Redox 1 (0.0 - 1.0)** |
| **422-423** | **calc_alpha_redox2** | **EMA Alpha для Redox 2 (0.0 - 1.0)** |
| **424-425** | **tok1_k** | **Коэффициент тока фазы 1 (для pH)** |
| **426-427** | **tok2_k** | **Коэффициент тока фазы 2 (для pH)** |

#### Блок 430-447: Аналоговые выходы 4-20 mA (AO1-AO3) — все FLOAT

| Адрес | Параметр | Описание |
|-------|----------|----------|
| 430-431 | ao1_source | Источник AO1: 0=OFF, 1=pH, 2=C, 3=R1, 4=R2 (FLOAT) |
| 432-433 | ao1_min | Значение при 4 mA (FLOAT) |
| 434-435 | ao1_max | Значение при 20 mA (FLOAT) |
| 436-437 | ao2_source | Источник AO2 (FLOAT) |
| 438-439 | ao2_min | Значение при 4 mA |
| 440-441 | ao2_max | Значение при 20 mA |
| 442-443 | ao3_source | Источник AO3 (FLOAT) |
| 444-445 | ao3_min | Значение при 4 mA |
| 446-447 | ao3_max | Значение при 20 mA |

**Примечание:** Инверсия поддерживается — если min > max, то большие значения дадут 4 mA.

#### Блок 4000-4017: Результаты химии (FLOAT32)

| Адрес | Параметр |
|-------|----------|
| 4000-4001 | C_raw — сырая концентрация |
| 4002-4003 | C_filt — сглаженная (EMA) концентрация |
| 4004-4005 | C_acid — концентрация кислоты |
| 4006-4007 | C_alkali — концентрация щёлочи |
| 4008-4009 | **pH** — финальное значение |
| 4010-4011 | Redox1_raw |
| 4012-4013 | Redox1_avg — сглаженный (EMA) |
| 4014-4015 | Redox2_raw |
| 4016-4017 | Redox2_avg — сглаженный (EMA) |

---

## 7. Алгоритмы расчётов

### 7.1 Экспоненциальное сглаживание (EMA)

Вместо скользящего среднего используется формула:

`Y[n] = Y[n-1] * Alpha + X[n] * (1 - Alpha)`

Где:
- `Y[n]` — новое сглаженное значение
- `Y[n-1]` — предыдущее сглаженное значение
- `X[n]` — новое "сырое" измерение
- `Alpha` — коэффициент сглаживания (0.0 ... 1.0)

*Примечание:* При старте цикла `Y[0] = X[0]` (нет истории).

### 7.2 Расчёт pH

**Источник:** Канал AI1 (индекс 1)  
**Момент:** После фаз 1 и 2

```
1. Сырая концентрация:
   C_raw = (snapshot[0][1] + snapshot[1][1]) * calc_k_sum + calc_b_sum

2. Фильтрация (EMA):
   C_filt = prev_C * alpha_c + C_raw * (1 - alpha_c)

3. Определение среды:
   ЕСЛИ C_filt < -|calc_deadband_acid|:
       C_acid = |C_filt|
       // Делим концентрацию на 10 перед логарифмом
       pH = calc_k_acid * log10(C_acid / 10.0) + calc_b_acid
   
   ИНАЧЕ ЕСЛИ C_filt > |calc_deadband_alkali|:
       C_alkali = C_filt
       // Делим концентрацию на 100 перед логарифмом
       pH = calc_k_alkali * log10(C_alkali / 100.0) + calc_b_alkali
   
   ИНАЧЕ:
       pH = calc_ph_neutral  (нейтраль)
```

---

## 8. Файл конфигурации iter_params.txt

### Полный пример

```ini
# ===== Основные параметры =====
repeats=0                    # 0 = бесконечный цикл
phases=5                     # Количество фаз (1-5)

# ===== Фазы 1-5 (пример для фазы 1) =====
start_mV=-1000
end_mV=1000
step_mV=1000
period_ms=400
settle_ms=200
pause_ms=401

# ... (параметры остальных фаз) ...

# ===== Масштабирование каналов =====
ch1_k=0.1000
ch1_b=0.0000
# ... (для всех 8 каналов) ...

# ===== Настройки химии (pH) =====
calc_k_sum=1.0000
calc_b_sum=0.0000
calc_alpha_c=0.5             # EMA Alpha (0.0 - 1.0)
calc_deadband_acid=0.1000
calc_deadband_alkali=0.1000
calc_ph_neutral=7.0000
calc_k_acid=-1.0000
calc_b_acid=0.0000
calc_k_alkali=1.0000
calc_b_alkali=0.0000
calc_alpha_redox1=0.5        # EMA Alpha (0.0 - 1.0)
calc_alpha_redox2=0.5        # EMA Alpha (0.0 - 1.0)

# ===== Modbus Settings =====
rs485_ip=192.168.2.2
rs485_port=502
rs485_slave=1
rtu_port=/dev/ttyAP0
rtu_baud=9600
```

---

## 9. Сборка и развёртывание

### Кросс-компиляция (Docker)

```bash
# Windows
docker build -t adam-builder .
docker run --rm -v %cd%:/src adam-builder
```

### Makefile

```makefile
CC = arm-linux-gnueabihf-gcc
CFLAGS = -O2 -Wall -I../includes
LDFLAGS = -lmodbus -ladamapi -lm

all: iter_modbus_server_arm adam_step

iter_modbus_server_arm: iter_modbus_server.c
	$(CC) $(CFLAGS) -o $@ $< $(LDFLAGS)

adam_step: adam6224_iter_step.c
	$(CC) $(CFLAGS) -o $@ $< $(LDFLAGS)
```

---

## 10. История версий и исправлений

### iter_modbus_server.c

| Версия | Изменения |
|--------|-----------|
| v12 | **NEW:** Legacy Mirroring (0x4000+), EMA params |
| v11 | FIX: Утечка сокетов при MAX_CLIENTS |
| v10 | Настройка Modbus RTU через файл |

### adam6224_iter_step.c

| Версия | Изменения |
|--------|-----------|
| v21 | **NEW:** EMA фильтры, формула pH (/10, /100) |
| v20 | FIX: NULL check, fix паузы, fix repeats, fix g_stop |
| v19 | Настройка ADAM-6224 IP через файл |

---

## 11. Известные особенности

### Влияние Alpha
- `Alpha = 1.0`: Фильтрация отключена (значение = новому измерению).
- `Alpha = 0.1`: Сильное сглаживание (90% веса истории).

### Сброс фильтров
При каждом запуске нового цикла измерений (`START`) история фильтров сбрасывается.

---

## 12. Поддержка Legacy SCADA (Mirroring)

Система поддерживает "зеркальные" регистры для совместимости со старым оборудованием. Данные дублируются в область адресов **0x4000+** (16384+).

### Карта соответствия (Mapping)

| Параметр | Внутренний адрес (DEC) | Legacy адрес (HEX) | Legacy адрес (DEC) |
|:---|:---:|:---:|:---:|
| **calc_deadband_acid** | 406 | **0x4025** | 16421 |
| **calc_deadband_alkali** | 408 | **0x402D** | 16429 |
| **Redox1_avg** | 4012 | **0x4031** | 16433 |
| **calc_b_alkali** | 418 | **0x4035** | 16437 |
| **calc_alpha_c** | 404 | **0x4037** | 16439 |
| **calc_alpha_redox1** | 420 | **0x4039** | 16441 |
| **calc_b_acid** | 414 | **0x403D** | 16445 |
| **calc_k_sum** | 400 | **0x4043** | 16451 |
| **calc_b_sum** | 402 | **0x4045** | 16453 |
| **ch3_k** | 204 | **0x4047** | 16455 |
| **ch3_b** | 220 | **0x4049** | 16457 |
| **calc_ph_neutral** | 410 | **0x404B** | 16459 |
| **pH** | 4008 | **0x404D** | 16461 |
| **C_alkali** | 4006 | **0x404F** | 16463 |
| **C_acid** | 4004 | **0x4051** | 16465 |
| **Ph1_Ch3** (Snapshot) | 3004 | **0x401B** | 16411 |
| **Ph2_Ch3** (Snapshot) | 3020 | **0x401D** | 16413 |
| **Calc_Ch1** (Current) | 1000 | **0x4013** | 16403 |

*Примечание:* Запись в Legacy-адреса автоматически обновляет внутренние параметры и сохраняет их в файл. 
Чтение из Legacy-адресов возвращает актуальные значения (синхронизация происходит постоянно в фоновом режиме).

---

*Документация создана: 25 ноября 2025*
