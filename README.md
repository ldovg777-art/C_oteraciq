# C_oteraciq: Система электрохимического анализа

**Платформа:** Advantech ADAM-6717 (Linux ARM)
**Версии ПО:** Server v9 / Worker v13

---

## 1. Описание системы
Программный комплекс предназначен для автоматизации процессов вольтамперометрии и титрования. Контроллер управляет напряжением поляризации, измеряет токи, рассчитывает электрохимические параметры (концентрация, pH, Redox) и сохраняет данные.

### Ключевые возможности:
1.  **Автономность:** Система автоматически запускается при подаче питания (скрипт автозапуска с защитой от сбоев драйверов).
2.  **Гибридная связь:**
    * **Ethernet (Modbus TCP, порт 1502):** Для связи с верхним уровнем и локального взаимодействия.
    * **RS-485 (Modbus RTU, /dev/ttyAP0):** Для связи с Панелью Оператора (HMI).
3.  **Надежность:**
    * Автоматическое восстановление связи при обрыве кабеля.
    * "Заморозка" таймера итерации при потере связи с модулем вывода.
4.  **Архивация:**
    * **Ротация файлов:** На диске всегда хранятся два файла: `iter_current.csv` (текущий процесс) и `iter_prev_full.csv` (последний успешный цикл). Это предотвращает переполнение памяти.
5.  **Вычисления на борту (Edge Computing):** Расчет концентрации и pH выполняется внутри контроллера.

---

## 2. Структура файлов проекта

### Исполняемые файлы (папка `/home/root/`)
* **`iter_modbus_server_arm`**: Сервер данных. Хранит уставки, обеспечивает связь Modbus TCP/RTU, сохраняет изменения параметров в файл.
* **`adam_step`**: Ядро измерений. Выполняет итерацию напряжения, опрос датчиков, математические расчеты и запись логов.

### Скрипты
* **`start_system.sh`**: Скрипт автозапуска. Настраивает пути к библиотекам (`LD_LIBRARY_PATH`) и запускает сервер и ядро в правильном порядке.

### Данные
* **`iter_params.txt`**: Файл конфигурации. Хранит параметры фаз и коэффициенты формул.
* **`iter_current.csv`**: Лог-файл текущего цикла.
* **`iter_prev_full.csv`**: Лог-файл предыдущего завершенного цикла.
* **`boot_diag.log`**: Лог диагностики запуска системы.
* **`worker_err.log`**: Лог ошибок программы измерений.

---

## 3. Карта Регистров Modbus (Адреса)

**Формат данных:** Float (32-bit Real), занимает 2 регистра.
**Порядок байт:** Big-Endian (на панели HMI: CDAB / Swap Words).
**Адресация:** 0-based (Внимание: на панелях Weintek/Siemens часто нужно прибавлять 1, т.е. адрес 400 -> 40001 или 40401).

### 3.1. Настройки Химии и pH (R/W - Чтение/Запись)
*Диапазон 400+. Сохраняются в файл при изменении.*

| Адрес | Переменная | Описание |
| :--- | :--- | :--- |
| **400** | `calc_k_sum` | Коэффициент (K) для суммы токов |
| **402** | `calc_b_sum` | Смещение (B) для суммы токов |
| **404** | `calc_filter_size` | Размер окна фильтра (от 1 до 20 измерений) |
| **406** | `calc_deadband_acid` | Порог нейтральной зоны для Кислоты (по модулю) |
| **408** | `calc_deadband_alkali`| Порог нейтральной зоны для Щёлочи |
| **410** | `calc_ph_neutral` | Значение pH в нейтральной зоне (обычно 7.0) |
| **412** | `calc_k_acid` | Коэффициент формулы pH для Кислоты |
| **414** | `calc_b_acid` | Константа формулы pH для Кислоты |
| **416** | `calc_k_alkali` | Коэффициент формулы pH для Щёлочи |
| **418** | `calc_b_alkali` | Константа формулы pH для Щёлочи |
| **420** | `calc_filter_redox1` | Размер фильтра для Redox 1 (Канал 2) |
| **422** | `calc_filter_redox2` | Размер фильтра для Redox 2 (Канал 3) |

### 3.2. Результаты Вычислений (Read Only)
*Диапазон 4000+. Обновляются в конце каждого цикла.*

| Адрес | Переменная | Описание |
| :--- | :--- | :--- |
| **4000** | `Res_Raw_Conc` | Сырая концентрация (до фильтрации) |
| **4002** | `Res_Filt_Conc` | Отфильтрованная общая концентрация |
| **4004** | `Res_Acid_Conc` | Итоговая концентрация Кислоты |
| **4006** | `Res_Alkali_Conc` | Итоговая концентрация Щёлочи |
| **4008** | `Res_pH` | **Финальное значение pH** |
| **4010** | `Res_Redox1_Raw` | Сырой Redox 1 (Канал 2, конец цикла) |
| **4012** | `Res_Redox1_Avg` | Усредненный Redox 1 |
| **4014** | `Res_Redox2_Raw` | Сырой Redox 2 (Канал 3, конец цикла) |
| **4016** | `Res_Redox2_Avg` | Усредненный Redox 2 |

### 3.3. Масштабирование каналов (R/W)
*Диапазон 200+. Индивидуальная настройка каждого канала AI.*
*Формула: Значение = Измерение * K + B*

* **200/202**: Ch0 (K / B)
* **204/206**: Ch1 (K / B)
* ...
* **230**: Ch7 (B)

### 3.4. Управление и Итерация (R/W)
* **0 ... 131**: Параметры фаз (Start mV, End mV, Step, Period, Settle, Pause).
* **132**: Командный регистр (1.0 = START, 2.0 = STOP, 3.0 = RESTART).

---

## 4. Алгоритмы и Формулы

### 4.1. Расчет Концентрации и pH
**Источник данных:** Канал AI1 (Ток).
**Момент измерения:** Середина паузы после Фазы 1 (`I_ph1`) и Фазы 2 (`I_ph2`).

1.  **Расчет сырой концентрации:**
    Сумма токов двух фаз приводится к условным единицам:
    `C_raw = (I_ph1 + I_ph2) * K_sum + B_sum`

2.  **Фильтрация:**
    Значение `C_raw` добавляется в буфер скользящего среднего.
    `C_filt = Среднее арифметическое буфера`

3.  **Определение среды и расчет pH:**
    Программа сравнивает `C_filt` с порогами мертвой зоны (Deadband):

    * **Случай А: Кислота** (Если `C_filt < -Deadband_acid`)
        * `C_acid = |C_filt|` (Берется модуль числа)
        * `C_alkali = 0`
        * `pH = K_acid * log10(C_acid) + B_acid`

    * **Случай Б: Щёлочь** (Если `C_filt > Deadband_alkali`)
        * `C_alkali = C_filt`
        * `C_acid = 0`
        * `pH = K_alkali * log10(C_alkali) + B_alkali`

    * **Случай В: Нейтраль** (Внутри зоны нечувствительности)
        * `C_acid = 0`
        * `C_alkali = 0`
        * `pH = pH_neutral` (фиксированное значение, уставка 410)

### 4.2. Расчет Redox (ОВП)
**Источники:** Канал AI2 (Redox 1) и Канал AI3 (Redox 2).
**Момент измерения:** Середина паузы после последней Фазы 5.

* Значения проходят независимую фильтрацию (скользящее среднее).
* Размеры фильтров задаются в регистрах 420 и 422.

---

## 5. Установка и Обслуживание

### Установка автозапуска
В файл `/etc/rc.local` добавить строку перед `exit 0`:
```bash
/home/root/start_system.sh &