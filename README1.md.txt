Вот обновленный файл **README.md**, в котором отражены все наши последние изменения:

1.  **Мультиплексирование сервера:** Описание новой архитектуры `iter_modbus_server` на базе `select()`, которая позволяет одновременно управлять процессом с панели HMI и локального приложения.
2.  **Дополнительное измерение:** Добавлено описание логики замера в середине паузы после фазы (Mid-Pause Measurement).
3.  **Автозапуск и управление:** Добавлен раздел с инструкциями по настройке `start_system.sh`, добавлению в автозагрузку и командам остановки процесса.

Вы можете скопировать этот текст и полностью заменить содержимое вашего `README.md`.

-----

# C\_oteraciq

**Контроллер итерации для ADAM-6717 + ADAM-6224 (C-программа)**

## 1\. Цель проекта

Реализовать внешний контроллер итерации на языке C, работающий на модуле Advantech ADAM-6717, который:

  * Управляет аналоговым выходом **AO0** модуля ADAM-6224 по Modbus/TCP.
  * Обеспечивает жёстко стабильную во времени итерацию (линейный профиль напряжения).
  * На каждом шаге итерации измеряет все **8 аналоговых входов AI0…AI7** ADAM-6717.
  * Выполняет **дополнительное контрольное измерение** в середине паузы между фазами (для контроля дрейфа/релаксации).
  * Логирует данные в CSV-файл.
  * Управляется (Старт/Стоп/Рестарт/Параметры) через Панель Оператора (HMI) по Modbus TCP с мгновенной реакцией.

## 2\. Аппаратная конфигурация

  * **Контроллер:** Advantech ADAM-6717 (Linux armhf, RT-kernel).
  * **Модуль вывода (AO):** Advantech ADAM-6224 (Modbus/TCP, IP: 192.168.2.2, Slave ID: 1).
  * **Модуль ввода (AI):** Встроенные каналы ADAM-6717 (AI0…AI7), работа через библиотеку `adamapi`.
  * **Панель оператора (HMI):** Подключается к ADAM-6717 по порту 1502 (Modbus TCP).

## 3\. Общая архитектура решения

Система состоит из двух независимых процессов, работающих параллельно на ADAM-6717:

1.  **`iter_modbus_server_arm` (Сервер настроек и управления):**

      * Работает на порту **1502**.
      * Использует системный вызов `select()` для **мультиплексирования подключений**.
      * Одновременно обслуживает Панель Оператора (HMI) и локальную программу измерений.
      * Хранит параметры в оперативной памяти (Modbus-регистры) и синхронизирует их с файлом `iter_params.txt`.
      * Принимает команды управления (START, STOP, RESTART).

2.  **`adam6224_iter_step_arm` (Ядро измерений):**

      * Читает параметры из `iter_params.txt`.
      * Выполняет цикл установки напряжения и сбора данных.
      * Подключается к локальному серверу (`127.0.0.1:1502`) как клиент, чтобы проверять статус кнопок «Пауза» или «Рестарт» в реальном времени.

## 4\. Реализация измерений: adam6224\_iter\_step.c

Основная логика работы:

1.  **Инициализация:**

      * Загрузка параметров.
      * Открытие AI (ADAM-6717) и отключение автофильтра (`AI_SetAutoFilterEnabled`).
      * Подключение к AO (ADAM-6224) и локальному серверу управления.

2.  **Итерационный цикл (Scan):**

      * Используется монотонное время `CLOCK_MONOTONIC` и `clock_nanosleep(TIMER_ABSTIME)` для исключения временного дрейфа.
      * **Шаг:** Установка напряжения на AO → Ожидание стабилизации (`settle_ms`) → Измерение 8 каналов AI → Запись в CSV.

3.  **Измерение в паузе (Mid-Pause Measurement):**

      * Если в параметрах фазы задана пауза (`pause_ms > 0`), программа:
        1.  Ждет половину времени паузы (`pause_ms / 2`).
        2.  Выполняет **дополнительный замер** всех 8 каналов (напряжение на выходе в это время равно конечному значению фазы).
        3.  Записывает отдельную строку в CSV (помечается тем же номером фазы, но время соответствует середине паузы).
        4.  Ждет оставшуюся часть паузы.

4.  **Обработка команд:**

      * Между шагами программа опрашивает локальный Modbus-регистр управления.
      * При получении команды **STOP** (Пауза) — замирает и ждет команды продолжения.
      * При получении команды **RESTART** — немедленно перечитывает файл параметров и начинает цикл заново.

## 5\. Modbus TCP Сервер (iter\_modbus\_server)

Сервер является мостом между оператором и файловой системой.

  * **Порт:** 1502.
  * **Архитектура:** Single-thread with `select()`.
  * **Возможности:**
      * Поддерживает **множественные подключения** (Multi-client). Панель оператора не блокирует доступ к регистрам для программы измерений.
      * **Карта регистров (0-based Addressing, Big-Endian):**
          * `0-65` (INT32): Параметры итерации (start\_mV, period\_ms и т.д.) в формате целых чисел.
          * `66-131` (FLOAT32): Те же параметры, дублированные в формате Float для удобства отображения на HMI.
          * `132-133` (FLOAT32/INT): Регистр управления.
              * `1.0` (или бит 0) = **START**
              * `2.0` (или бит 1) = **STOP (PAUSE)**
              * `3.0` (или бит 2) = **RESTART**

*Важно:* При настройке HMI панели выбирайте **четные адреса** (66, 68...) для 32-битных Float переменных и проверяйте порядок слов (Word Order), если значения отображаются некорректно (иногда требуется Swap Words / ABCD-\>CDAB).

## 6\. Параметры итерации: iter\_params.txt

Файл `/home/root/iter_params.txt`. Пример с настройкой паузы для дополнительного замера:

```ini
repeats=0
phases=1

# Фаза 1: Спуск от 100 мВ до 0 мВ
start_mV=100
end_mV=0
step_mV=10
period_ms=1000
settle_ms=500
# Пауза 2 секунды после фазы (в середине, на 1-й секунде, будет сделан замер)
pause_ms=2000
```

## 7\. Формат CSV-лога

Файл: `iter_8ch_YYYYMMDD_HHMMSS.csv`

```csv
cycle;phase;idx;time_ms;iter_mV;iter_V;code_set;ao_V;AI0;AI1;AI2;AI3;AI4;AI5;AI6;AI7
```

  * **Дополнительная строка измерения в паузе** выглядит так же, как обычная, но время (`time_ms`) будет соответствовать середине паузы, а `iter_mV` — конечному значению завершенной фазы.

## 8\. Автозапуск и Управление

Для автономной работы устройства настроен скрипт автозапуска.

### Скрипт запуска

Файл `/home/root/start_system.sh`:

```bash
#!/bin/sh
cd /home/root/
./iter_modbus_server_arm &  # Запуск сервера в фоне
sleep 2                     # Ожидание инициализации порта
./adam_step &               # Запуск измерений в фоне
```

### Настройка автозагрузки (rc.local)

В файл `/etc/rc.local` добавлена строка перед `exit 0`:

```bash
/home/root/start_system.sh &
```

### Управление из консоли (SSH)

1.  **Проверить, работают ли процессы:**

    ```bash
    ps | grep adam
    # Или
    ps | grep iter
    ```

2.  **Остановить всё (для обновления ПО):**

    ```bash
    killall iter_modbus_server_arm adam_step
    ```

    Программы корректно обработают сигнал `SIGTERM`, закроют файлы логов и сокеты перед выходом.

3.  **Ручной запуск (если остановлено):**

    ```bash
    /home/root/start_system.sh
    ```

## 9\. Сборка и Деплой

**Компиляция сервера:**

```bash
docker run ... gcc -O2 iter_modbus_server.c -o iter_modbus_server_arm -lmodbus
```

**Компиляция программы измерений:**

```bash
docker run ... gcc -O2 adam6224_iter_step.c -o adam_step -I./includes -L./libs -ladamapi -lmodbus
```

**Установка прав на устройстве:**

```bash
chmod +x iter_modbus_server_arm adam_step start_system.sh
```